<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-pop Playlist Generator üé∂‚ú®</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fceabb, #f8b500); min-height: 100vh; color: #333; overflow-x: hidden; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.header { text-align: center; margin-bottom: 40px; }
.header h1 { font-size: 3rem; font-weight: 700; background: linear-gradient(45deg, #ffb3ba, #ffdfba, #ffffba, #baffc9, #bae1ff); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 4px 20px rgba(0,0,0,0.1); }
.header p { font-size: 1.2rem; color: #333; opacity: 0.9; margin-top: 10px; }
.auth-section { text-align: center; background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-radius: 25px; padding: 40px; margin-bottom: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
.auth-btn { background: #ffb3ba; color: #333; border: none; padding: 15px 35px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
.auth-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
.controls { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-radius: 25px; padding: 30px; margin-bottom: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
.control-group { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
.control-section { flex: 1; min-width: 180px; }
.control-section h3 { font-size: 1.1rem; margin-bottom: 10px; font-weight: 600; color: #444; display: flex; align-items: center; gap: 5px; }
select { width: 100%; padding: 12px 16px; border: none; border-radius: 15px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-size: 1rem; transition: 0.3s ease; cursor: pointer; }
select:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,182,193,0.3); }
.generate-btn { background: linear-gradient(45deg,#ffb3ba,#ffdfba,#ffffba); color: #333; border: none; padding: 15px 35px; border-radius: 30px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin: 20px auto 0; display: block; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: all 0.3s ease; }
.generate-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
.playlist { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
.track-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-radius: 20px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); cursor: pointer; }
.album-cover { width: 100%; height: 200px; border-radius: 15px; object-fit: cover; margin-bottom: 10px; }
.track-title { font-size: 1.1rem; font-weight: 600; color: #333; }
.track-artist { color: #666; font-size: 0.9rem; margin-bottom: 8px; }
.play-btn { background: linear-gradient(45deg,#ffb3ba,#ffdfba); color: #333; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.debug-info { background: rgba(255,255,255,0.9); border-radius: 15px; padding: 20px; margin: 20px 0; font-family: monospace; font-size: 0.9rem; color: #666; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>K-pop Playlist Generator üé∂‚ú®</h1>
        <p>Discover amazing K-pop tracks based on your mood and vibe</p>
    </div>

    <div id="authSection" class="auth-section">
        <h2>üéµ Connect to Spotify</h2>
        <p style="margin: 20px 0; color: #666;">Connect your Spotify account to generate real K-pop playlists!</p>
        <button class="auth-btn" onclick="authenticateSpotify()">üéß Connect Spotify</button>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="controls">
            <div class="control-group">
                <div class="control-section">
                    <h3>üòä Mood</h3>
                    <select id="moodSelect">
                        <option value="">Select...</option>
                        <option value="happy energetic">üòÑ Happy</option>
                        <option value="chill relaxed">üòå Chill</option>
                        <option value="energetic powerful">‚ö° Energetic</option>
                        <option value="sad emotional">üò¢ Sad</option>
                        <option value="romantic love">üíï Romantic</option>
                    </select>
                </div>
                <div class="control-section">
                    <h3>üé® Concept</h3>
                    <select id="conceptSelect">
                        <option value="">Select...</option>
                        <option value="cute kawaii">üå∏ Cute</option>
                        <option value="fierce powerful">üî• Fierce</option>
                        <option value="retro vintage">üï∫ Retro</option>
                        <option value="dreamy ethereal">‚òÅÔ∏è Dreamy</option>
                        <option value="dark mysterious">üñ§ Dark</option>
                    </select>
                </div>
            </div>
            <button class="generate-btn" onclick="generatePlaylist()">‚ú® Generate Playlist ‚ú®</button>
        </div>

        <div id="playlist" class="playlist"></div>
    </div>
</div>

<script>
const CLIENT_ID = "7cf87153ad1742ca9b098e0d63d55db0";
const REDIRECT_URI = "https://kmaanasar.github.io/K-Pop-Playlist-Generator/";
const SCOPES = "user-read-private user-read-email";
let currentAudio = null;
let playingTrackId = '';
const kpopKeywords = ['BTS','BLACKPINK','TWICE','ITZY','aespa','Red Velvet','MAMAMOO','SEVENTEEN','Stray Kids','ENHYPEN','TXT','IVE','NewJeans','LE SSERAFIM','NMIXX','EVERGLOW','ATEEZ','NCT','IU','EXO','SHINee'];

// --- Step 1: Authenticate ---
function authenticateSpotify() {
    const authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
    window.location.href = authURL;
}

// --- Step 2: On page load, exchange code for token ---
window.onload = async () => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
        try {
            const res = await fetch('https://kpopplaylistgenerator-4dvzmv2f3.vercel.app/api/exchange_token', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ code, redirect_uri: REDIRECT_URI })
            });
            if (!res.ok) throw new Error("Failed to get access token");
            const data = await res.json();
            const accessToken = data.access_token;

            if (accessToken) {
                window.accessToken = accessToken;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        } catch (err) {
            console.error("Failed to get access token", err);
            alert("Failed to connect to Spotify. Try again.");
        }
    }
};

// --- Generate playlist ---
async function generatePlaylist() {
    const mood = document.getElementById('moodSelect').value;
    const concept = document.getElementById('conceptSelect').value;

    if (!mood && !concept) { alert('Select at least one option!'); return; }

    const queries = buildSearchQueries(mood, concept);
    let allTracks = [];

    for (let q of queries) {
        const tracks = await searchKpopTracks(q, 5);
        allTracks.push(...tracks);
    }

    const uniqueTracks = allTracks.filter((track, idx, arr) => idx === arr.findIndex(t => t.id === track.id));
    displayPlaylist(uniqueTracks.sort(() => 0.5 - Math.random()).slice(0, 6));
}

function buildSearchQueries(mood, concept) {
    const artists = kpopKeywords.sort(() => 0.5 - Math.random()).slice(0,3);
    return artists.map(artist => {
        let parts = [];
        if (mood) parts.push(mood);
        if (concept) parts.push(concept);
        parts.push(`artist:${artist}`);
        parts.push("genre:k-pop");
        return parts.join(" ");
    });
}

async function searchKpopTracks(query, limit=10) {
    if (!window.accessToken) return generateSamplePlaylist();
    try {
        const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=${limit}`, {
            headers: { 'Authorization': `Bearer ${window.accessToken}` }
        });
        if (!res.ok) throw new Error("Spotify API error");
        const data = await res.json();
        return data.tracks.items || [];
    } catch(e) { console.error(e); return generateSamplePlaylist(); }
}

function generateSamplePlaylist() {
    return [
        { id:'1', name:'Dynamite', artists:[{name:'BTS'}], album:{images:[{url:'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=300&h=300&fit=crop'}]}, preview_url:null },
        { id:'2', name:'How You Like That', artists:[{name:'BLACKPINK'}], album:{images:[{url:'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=300&h=300&fit=crop'}]}, preview_url:null }
    ];
}

function displayPlaylist(tracks) {
    const container = document.getElementById('playlist');
    container.innerHTML = '';
    tracks.forEach(t=>{
        const card = document.createElement('div');
        card.className='track-card';
        card.innerHTML=`
            <img src="${t.album.images[0]?.url}" class="album-cover">
            <div class="track-info">
                <div class="track-title">${t.name}</div>
                <div class="track-artist">${t.artists.map(a=>a.name).join(', ')}</div>
                <button class="play-btn" onclick="togglePlay('${t.id}','${t.preview_url}')">
                    <span id="play-icon-${t.id}">‚ñ∂Ô∏è</span>
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

function togglePlay(id,url){
    if(playingTrackId===id){currentAudio?.pause(); document.getElementById(`play-icon-${id}`).textContent='‚ñ∂Ô∏è'; playingTrackId=''; return;}
    if(currentAudio){currentAudio.pause(); document.getElementById(`play-icon-${playingTrackId}`).textContent='‚ñ∂Ô∏è';}
    if(url){currentAudio=new Audio(url); currentAudio.play(); currentAudio.onended=()=>{document.getElementById(`play-icon-${id}`).textContent='‚ñ∂Ô∏è'; playingTrackId='';}; document.getElementById(`play-icon-${id}`).textContent='‚è∏Ô∏è'; playingTrackId=id;}
    else{document.getElementById(`play-icon-${id}`).textContent='‚è∏Ô∏è'; playingTrackId=id; setTimeout(()=>{document.getElementById(`play-icon-${id}`).textContent='‚ñ∂Ô∏è'; playingTrackId='';},3000);}
}
</script>
</body>
</html>
