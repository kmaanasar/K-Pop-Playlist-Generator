<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K-pop Playlist Generator üé∂‚ú®</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: #333; overflow-x: hidden;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 40px; }
    .header h1 {
  font-size: 3.5rem; font-weight: 700;
  background: linear-gradient(45deg, #ff6b9d, #c44569);
  background-clip: text;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-shadow: 0 4px 20px rgba(255, 107, 157, 0.3);
    }
    .header p { font-size: 1.2rem; color: #fff; opacity: 0.9; font-weight: 300; }
    .controls {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border-radius: 20px; padding: 30px; margin-bottom: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .control-group { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    .control-section { flex: 1; min-width: 200px; }
    .control-section h3 { font-size: 1.1rem; margin-bottom: 10px; font-weight: 600; color: #444; }
    select {
      width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9;
      border-radius: 12px; font-size: 1rem; background: white;
      transition: 0.3s ease; cursor: pointer;
    }
    select:focus { outline: none; border-color: #ff6b9d; box-shadow: 0 0 0 3px rgba(255,107,157,0.1); }
    .generate-btn {
      background: linear-gradient(45deg,#ff6b9d,#c44569); color: white;
      border: none; padding: 15px 30px; border-radius: 25px;
      font-size: 1.1rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 10px 20px rgba(255,107,157,0.3);
      display: block; margin: 20px auto 0;
    }
    .playlist { display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap: 20px; }
    .track-card {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border-radius: 16px; padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      transition: 0.3s ease; cursor: pointer;
    }
    .track-card:hover { transform: translateY(-8px); }
    .album-cover { width: 100%; height: 200px; border-radius: 12px; object-fit: cover; margin-bottom: 15px; }
    .track-title { font-size: 1.1rem; font-weight: 600; color: #333; }
    .track-artist { color: #666; font-size: 0.9rem; margin-bottom: 8px; }
    .play-btn {
      background: linear-gradient(45deg,#ff6b9d,#c44569); color: white;
      border: none; border-radius: 50%; width: 45px; height: 45px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .auth-section {
      text-align: center; background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px); border-radius: 20px;
      padding: 40px; margin-bottom: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .auth-btn {
      background: #1db954; color: white; border: none;
      padding: 15px 30px; border-radius: 25px;
      font-size: 1.1rem; font-weight: 600; cursor: pointer;
    }
    .loading { text-align: center; color: white; font-size: 1.2rem; margin: 40px 0; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #ff6b9d;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>K-pop Playlist Generator üé∂‚ú®</h1>
      <p>Discover amazing K-pop tracks based on your mood and vibe</p>
    </div>

    <div id="authSection" class="auth-section">
      <h2>üéµ Connect to Spotify</h2>
      <p style="margin: 20px 0; color: #666;">Connect your Spotify account to generate personalized K-pop playlists!</p>
      <button class="auth-btn" onclick="authenticateSpotify()">üéß Connect Spotify</button>
    </div>

    <div id="mainApp" style="display: none;">
      <div class="controls">
        <div class="control-group">
          <div class="control-section">
            <h3>üòä Mood</h3>
            <select id="moodSelect">
              <option value="">Select...</option>
              <option value="happy">üòÑ Happy</option>
              <option value="chill">üòå Chill</option>
              <option value="energetic">‚ö° Energetic</option>
              <option value="sad">üò¢ Sad</option>
              <option value="romantic">üíï Romantic</option>
            </select>
          </div>
          <div class="control-section">
            <h3>üé® Concept</h3>
            <select id="conceptSelect">
              <option value="">Select...</option>
              <option value="cute">üå∏ Cute</option>
              <option value="fierce">üî• Fierce</option>
              <option value="retro">üï∫ Retro</option>
              <option value="dreamy">‚òÅÔ∏è Dreamy</option>
              <option value="dark">üñ§ Dark</option>
            </select>
          </div>
          <div class="control-section">
            <h3>üåø Season</h3>
            <select id="seasonSelect">
              <option value="">Select...</option>
              <option value="summer">‚òÄÔ∏è Summer</option>
              <option value="winter">‚ùÑÔ∏è Winter</option>
              <option value="spring">üå± Spring</option>
              <option value="autumn">üçÇ Fall</option>
            </select>
          </div>
        </div>
        <button class="generate-btn" onclick="generatePlaylist()">‚ú® Generate Playlist ‚ú®</button>
      </div>
      <div id="loading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <p>Creating your perfect K-pop playlist... üéµ</p>
      </div>
      <div id="playlist" class="playlist"></div>
    </div>
  </div>

  <script>
    // --- Config ---
        // ===== CONFIG =====
    const CLIENT_ID = "9738f4282c9b4019b378f8d68b43cffa";  // Replace with your Client ID
    const REDIRECT_URI = "https://kmaanasar.github.io/K-Pop-Playlist-Generator/"; // Or your live URL
    const SCOPES = "user-read-private user-read-email playlist-modify-public";
    let accessToken = null;
    let currentAudio = null;
    let playingTrackId = '';

    const kpopKeywords = [
      'BTS','BLACKPINK','TWICE','ITZY','aespa','Red Velvet','MAMAMOO',
      'SEVENTEEN','Stray Kids','ENHYPEN','TXT','IVE','NewJeans',
      'LE SSERAFIM','NMIXX','EVERGLOW','ATEEZ','NCT','IU','EXO','SHINee'
    ];

    // --- PKCE Helpers ---
    function generateCodeVerifier(length) {
      let text = ''; let chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      for (let i=0;i<length;i++) text += chars.charAt(Math.floor(Math.random()*chars.length));
      return text;
    }
    async function generateCodeChallenge(v) {
      const data = new TextEncoder().encode(v);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    async function authenticateSpotify() {
      const verifier = generateCodeVerifier(128);
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem("code_verifier", verifier);

      const authUrl = new URL("https://accounts.spotify.com/authorize");
      authUrl.searchParams.append("client_id", CLIENT_ID);
      authUrl.searchParams.append("response_type", "code");
      authUrl.searchParams.append("redirect_uri", REDIRECT_URI);
      authUrl.searchParams.append("scope", SCOPES);
      authUrl.searchParams.append("code_challenge_method", "S256");
      authUrl.searchParams.append("code_challenge", challenge);

      window.location.href = authUrl.toString();
    }

    window.addEventListener("load", async () => {
      const code = new URLSearchParams(window.location.search).get("code");
      if (code) {
        const verifier = localStorage.getItem("code_verifier");
        const body = new URLSearchParams({
          client_id: CLIENT_ID, grant_type: "authorization_code",
          code, redirect_uri: REDIRECT_URI, code_verifier: verifier
        });

        const res = await fetch("https://accounts.spotify.com/api/token", {
          method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded"}, body
        });
        const data = await res.json();
        accessToken = data.access_token;

        document.getElementById("authSection").style.display="none";
        document.getElementById("mainApp").style.display="block";
        window.history.replaceState({}, document.title, REDIRECT_URI);
      }
    });

    function buildSearchQuery(mood, concept, season) {
      const parts = [];
      if (mood) parts.push(mood);
      if (concept) parts.push(concept);
      if (season) parts.push(season);
      parts.push(kpopKeywords[Math.floor(Math.random()*kpopKeywords.length)]);
      parts.push("kpop");
      return parts.join(" ");
    }

    async function searchKpopTracks(query, limit=10) {
      const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=${limit}`, {
        headers:{Authorization:`Bearer ${accessToken}`}
      });
      const data = await res.json();
      return data.tracks.items;
    }

    async function generatePlaylist() {
      const mood = document.getElementById("moodSelect").value;
      const concept = document.getElementById("conceptSelect").value;
      const season = document.getElementById("seasonSelect").value;
      if (!mood && !concept && !season) { alert("Pick at least one!"); return; }

      document.getElementById("loading").style.display="block";
      document.getElementById("playlist").innerHTML="";

      const query = buildSearchQuery(mood, concept, season);
      const tracks = await searchKpopTracks(query, 12);

      displayPlaylist(tracks);
      document.getElementById("loading").style.display="none";
    }

    function displayPlaylist(tracks) {
      const playlistContainer = document.getElementById("playlist");
      playlistContainer.innerHTML="";
      tracks.forEach(track => {
        const card = document.createElement("div");
        card.className="track-card";
        card.innerHTML = `
          <img src="${track.album.images[0]?.url}" class="album-cover">
          <div class="track-info">
            <div class="track-title">${track.name}</div>
            <div class="track-artist">${track.artists.map(a=>a.name).join(", ")}</div>
            <button class="play-btn" onclick="togglePlay('${track.id}','${track.preview_url||''}')">
              <span id="play-icon-${track.id}">‚ñ∂Ô∏è</span>
            </button>
          </div>`;
        playlistContainer.appendChild(card);
      });
    }

    function togglePlay(id, url) {
      if (playingTrackId === id) {
        if (currentAudio) currentAudio.pause();
        document.getElementById(`play-icon-${id}`).textContent="‚ñ∂Ô∏è";
        playingTrackId="";
        return;
      }
      if (currentAudio) {
        currentAudio.pause();
        document.getElementById(`play-icon-${playingTrackId}`).textContent="‚ñ∂Ô∏è";
      }
      if (url) {
        currentAudio=new Audio(url);
        currentAudio.play();
        currentAudio.onended=()=>{ document.getElementById(`play-icon-${id}`).textContent="‚ñ∂Ô∏è"; playingTrackId=""; };
        document.getElementById(`play-icon-${id}`).textContent="‚è∏Ô∏è";
        playingTrackId=id;
      }
    }
  </script>
</body>
</html>
